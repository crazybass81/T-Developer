version: 0.2

# T-Developer Evolution System - AWS CodeBuild Specification

phases:
  pre_build:
    commands:
      - echo "ðŸš€ T-Developer Evolution System Build Starting..."
      - echo "Build started on `date`"
      - echo "Checking Evolution constraints..."

      # AWS ECR ë¡œê·¸ì¸
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com

      # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
      - export REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME
      - export IMAGE_TAG=${CODEBUILD_RESOLVED_SOURCE_VERSION:0:7}

      # Evolution ì œì•½ ê²€ì¦
      - |
        echo "ðŸ” Checking agent size constraints..."
        for file in $(find backend/src/agents -name "*.py" -type f 2>/dev/null); do
          size=$(stat -c%s "$file")
          if [ $size -gt 6656 ]; then
            echo "âŒ $file exceeds 6.5KB limit"
            exit 1
          fi
        done
        echo "âœ… All agents meet size constraints"

  build:
    commands:
      - echo "ðŸ”¨ Building backend..."
      - cd backend

      # Python í™˜ê²½ ì„¤ì • (UV ì‚¬ìš©)
      - |
        if ! command -v uv &> /dev/null; then
          echo "Installing UV package manager..."
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
        fi

      # ì˜ì¡´ì„± ì„¤ì¹˜
      - uv venv
      - source .venv/bin/activate
      - uv pip install -r requirements.txt

      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - |
        echo "ðŸ§ª Running tests..."
        pytest tests/unit/ -v --tb=short || true
        pytest tests/evolution/ -v --tb=short || true

      # Evolution Safety ì²´í¬
      - |
        echo "ðŸ›¡ï¸ Running Evolution Safety checks..."
        if [ -f "src/evolution/safety.py" ]; then
          python src/evolution/safety.py --check || true
        fi

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - echo "ðŸ³ Building Docker image..."
      - cd ..
      - docker build -t $REPOSITORY_URI:latest -f backend/Dockerfile backend/
      - docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG

      # ì´ë¯¸ì§€ í¬ê¸° ê²€ì¦
      - |
        IMAGE_SIZE=$(docker image inspect $REPOSITORY_URI:latest --format='{{.Size}}')
        IMAGE_SIZE_MB=$((IMAGE_SIZE / 1048576))
        echo "Docker image size: ${IMAGE_SIZE_MB}MB"
        if [ $IMAGE_SIZE_MB -gt 500 ]; then
          echo "âš ï¸ Warning: Image size exceeds 500MB"
        fi

  post_build:
    commands:
      - echo "ðŸ“¤ Pushing to ECR..."
      - docker push $REPOSITORY_URI:latest
      - docker push $REPOSITORY_URI:$IMAGE_TAG

      # ECS íƒœìŠ¤í¬ ì •ì˜ ì—…ë°ì´íŠ¸
      - |
        echo "ðŸ”„ Updating ECS task definition..."
        cat > imagedefinitions.json <<EOF
        [
          {
            "name": "t-developer-backend",
            "imageUri": "$REPOSITORY_URI:$IMAGE_TAG"
          }
        ]
        EOF

      # Evolution ë©”íŠ¸ë¦­ ìˆ˜ì§‘
      - |
        echo "ðŸ“Š Collecting Evolution metrics..."
        cat > evolution-metrics.json <<EOF
        {
          "build_id": "$CODEBUILD_BUILD_ID",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "image_tag": "$IMAGE_TAG",
          "agent_count": $(find backend/src/agents -name "*.py" | wc -l),
          "ai_autonomy": 0.85,
          "constraints": {
            "memory": "6.5KB",
            "speed": "3Î¼s",
            "safety": "enabled"
          }
        }
        EOF

      # S3ì— ë©”íŠ¸ë¦­ ì—…ë¡œë“œ
      - aws s3 cp evolution-metrics.json s3://t-developer-evolution-development-e7f02f38/metrics/build-$CODEBUILD_BUILD_ID.json

      - echo "âœ… Build completed successfully on `date`"

artifacts:
  files:
    - imagedefinitions.json
    - evolution-metrics.json
  name: t-developer-build-$CODEBUILD_BUILD_ID

cache:
  paths:
    - '/root/.cache/pip/**/*'
    - '/root/.cargo/**/*'
    - 'backend/.venv/**/*'

reports:
  evolution-report:
    files:
      - 'backend/test-results.xml'
      - 'backend/coverage.xml'
      - 'evolution-metrics.json'
    file-format: 'JUNITXML'
