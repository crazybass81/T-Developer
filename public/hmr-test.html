<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔥 HMR 테스트 페이지</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .status {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .connected {
            background: rgba(40, 167, 69, 0.8);
            border: 2px solid #28a745;
        }
        
        .disconnected {
            background: rgba(220, 53, 69, 0.8);
            border: 2px solid #dc3545;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .info-card h3 {
            margin-top: 0;
            color: #ffd700;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s ease;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .timestamp {
            color: #ffd700;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔥 Hot Module Replacement 테스트</h1>
        
        <div id="status" class="status disconnected">
            HMR WebSocket 연결 중...
        </div>
        
        <div class="info-grid">
            <div class="info-card">
                <h3>📊 연결 정보</h3>
                <p><strong>WebSocket URL:</strong> ws://localhost:3001</p>
                <p><strong>현재 시간:</strong> <span id="time"></span></p>
                <p><strong>페이지 로드:</strong> <span id="loadTime"></span></p>
            </div>
            
            <div class="info-card">
                <h3>🔄 HMR 상태</h3>
                <p><strong>연결 상태:</strong> <span id="connectionStatus">연결 중...</span></p>
                <p><strong>재연결 횟수:</strong> <span id="reconnectCount">0</span></p>
                <p><strong>마지막 이벤트:</strong> <span id="lastEvent">없음</span></p>
            </div>
        </div>
        
        <div class="test-section">
            <h3>🧪 테스트 기능</h3>
            <p>다음 기능들을 테스트해보세요:</p>
            <button onclick="testReload()">수동 새로고침</button>
            <button onclick="testWebSocket()">WebSocket 테스트</button>
            <button onclick="clearLog()">로그 지우기</button>
            
            <div class="log" id="log">
                <div class="timestamp">[시작]</div> HMR 테스트 페이지가 로드되었습니다.
            </div>
        </div>
        
        <div class="test-section">
            <h3>📝 HMR 테스트 방법</h3>
            <ol>
                <li><strong>파일 수정:</strong> backend/src 폴더의 TypeScript 파일을 수정하세요</li>
                <li><strong>자동 감지:</strong> Chokidar가 파일 변경을 감지합니다</li>
                <li><strong>핫 리로드:</strong> 변경된 모듈이 자동으로 리로드됩니다</li>
                <li><strong>브라우저 새로고침:</strong> WebSocket을 통해 브라우저가 새로고침됩니다</li>
            </ol>
        </div>
    </div>

    <script>
        let ws;
        let reconnectCount = 0;
        let isConnected = false;
        
        function updateTime() {
            document.getElementById('time').textContent = new Date().toLocaleString();
        }
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `<br><span class="timestamp">[${timestamp}]</span> ${message}`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:3001');
            
            ws.onopen = () => {
                isConnected = true;
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = '🟢 HMR WebSocket 연결됨';
                document.getElementById('connectionStatus').textContent = '연결됨';
                log('WebSocket 연결 성공');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                document.getElementById('lastEvent').textContent = data.action;
                
                switch (data.action) {
                    case 'reload':
                        log('🔄 파일 변경 감지 - 페이지 새로고침');
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                        break;
                        
                    case 'restart':
                        log('🔄 서버 재시작 감지 - 페이지 새로고침');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                        break;
                        
                    case 'css':
                        log('🎨 CSS 업데이트');
                        updateCSS(data.file);
                        break;
                        
                    default:
                        log(`📨 알 수 없는 이벤트: ${data.action}`);
                }
            };
            
            ws.onclose = () => {
                isConnected = false;
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = '🔴 HMR WebSocket 연결 끊김';
                document.getElementById('connectionStatus').textContent = '연결 끊김';
                log('WebSocket 연결 끊김 - 재연결 시도 중...');
                
                // 재연결 시도
                setTimeout(() => {
                    reconnectCount++;
                    document.getElementById('reconnectCount').textContent = reconnectCount;
                    connectWebSocket();
                }, 2000);
            };
            
            ws.onerror = (error) => {
                log(`❌ WebSocket 오류: ${error.message || '연결 실패'}`);
            };
        }
        
        function updateCSS(file) {
            const links = document.querySelectorAll('link[rel="stylesheet"]');
            const link = Array.from(links).find(l => l.href.includes(file));
            
            if (link) {
                const newLink = link.cloneNode();
                newLink.href = link.href.split('?')[0] + '?t=' + Date.now();
                link.parentNode.replaceChild(newLink, link);
                log(`🎨 CSS 파일 업데이트: ${file}`);
            }
        }
        
        function testReload() {
            log('🧪 수동 새로고침 테스트');
            window.location.reload();
        }
        
        function testWebSocket() {
            if (isConnected) {
                log('🧪 WebSocket 연결 테스트 - 연결됨');
            } else {
                log('🧪 WebSocket 연결 테스트 - 연결 안됨');
                connectWebSocket();
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="timestamp">[지움]</div> 로그가 지워졌습니다.';
        }
        
        // 초기화
        document.getElementById('loadTime').textContent = new Date().toLocaleString();
        updateTime();
        setInterval(updateTime, 1000);
        connectWebSocket();
    </script>
</body>
</html>